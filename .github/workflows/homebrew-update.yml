# ✨ Homebrew Update — shared-workflows
# Updates the Homebrew formula in hyperb1iss/homebrew-tap.

name: Homebrew Update

on:
  workflow_call:
    inputs:
      formula-name:
        description: 'Formula name (e.g., git-iris or unifly)'
        type: string
        required: true
      tap-repo:
        description: 'Target tap repository'
        type: string
        default: 'hyperb1iss/homebrew-tap'
      description:
        description: 'Formula description'
        type: string
        required: true
      homepage:
        description: 'Formula homepage URL'
        type: string
        required: true
      binary-names:
        description: 'Space-separated binaries to install'
        type: string
        required: true
    secrets:
      HOMEBREW_TAP_TOKEN:
        required: true

concurrency:
  group: homebrew
  cancel-in-progress: false

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: 'binaries-*'
          path: artifacts/
          merge-multiple: false

      - name: Compute checksums and upload tarballs
        id: checksums
        env:
          GH_TOKEN: ${{ github.token }}
          FORMULA_NAME: ${{ inputs.formula-name }}
        run: |
          version="${GITHUB_REF_NAME#v}"
          echo "version=$version" >> "$GITHUB_OUTPUT"

          for target in linux-amd64 macos-arm64; do
            dir="artifacts/binaries-$target"
            if [ -d "$dir" ]; then
              tarball="${FORMULA_NAME}-${version}-${target}.tar.gz"
              tar -czf "$tarball" -C "$dir" .
              sha=$(sha256sum "$tarball" | cut -d' ' -f1)
              echo "${target//-/_}_sha=$sha" >> "$GITHUB_OUTPUT"

              # Upload tarball as release asset
              gh release upload "v${version}" "$tarball" \
                --repo "${{ github.repository }}" --clobber
              echo "✅ $target: $sha (uploaded)"
            fi
          done

      - name: Generate formula
        env:
          FORMULA_NAME: ${{ inputs.formula-name }}
          FORMULA_DESC: ${{ inputs.description }}
          FORMULA_HOMEPAGE: ${{ inputs.homepage }}
          BINARY_NAMES: ${{ inputs.binary-names }}
          VERSION: ${{ steps.checksums.outputs.version }}
          REPO: ${{ github.repository }}
          MACOS_SHA: ${{ steps.checksums.outputs.macos_arm64_sha }}
          LINUX_SHA: ${{ steps.checksums.outputs.linux_amd64_sha }}
        run: |
          # Convert formula-name to CamelCase Ruby class name
          # e.g., git-iris -> GitIris, unifly -> Unifly
          class_name=$(echo "$FORMULA_NAME" | sed -E 's/(^|-)([a-z])/\U\2/g')

          # Build binaries array for Ruby
          binaries=$(echo "$BINARY_NAMES" | tr ' ' '\n' | sed 's/.*/"&"/' | paste -sd', ' -)
          first_binary=$(echo "$BINARY_NAMES" | cut -d' ' -f1)

          cat > formula.rb << RUBY
          class ${class_name} < Formula
            desc "${FORMULA_DESC}"
            homepage "${FORMULA_HOMEPAGE}"
            version "${VERSION}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${REPO}/releases/download/v${VERSION}/${FORMULA_NAME}-${VERSION}-macos-arm64.tar.gz"
                sha256 "${MACOS_SHA}"
              end
            end

            on_linux do
              if Hardware::CPU.intel?
                url "https://github.com/${REPO}/releases/download/v${VERSION}/${FORMULA_NAME}-${VERSION}-linux-amd64.tar.gz"
                sha256 "${LINUX_SHA}"
              end
            end

            def install
              [${binaries}].each { |b| bin.install b }
            end

            test do
              system bin/"${first_binary}", "--version"
            end
          end
          RUBY

          # Strip leading whitespace from heredoc indentation
          sed -i 's/^          //' formula.rb
          cat formula.rb

      - name: Push formula to tap
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          FORMULA_NAME: ${{ inputs.formula-name }}
          TAP_REPO: ${{ inputs.tap-repo }}
          VERSION: ${{ steps.checksums.outputs.version }}
        run: |
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/${TAP_REPO}.git" tap
          cp formula.rb "tap/Formula/${FORMULA_NAME}.rb"
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${FORMULA_NAME}.rb"
          git commit -m "Update ${FORMULA_NAME} to ${VERSION}"
          git push
