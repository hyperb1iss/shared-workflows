# âœ¨ Rust Release â€” shared-workflows
# Version bump â†’ tag â†’ trigger downstream CI/CD.
# Each consuming repo keeps a thin release.yml with workflow_dispatch inputs
# that calls this shared workflow via workflow_call.

name: Rust Release

on:
  workflow_call:
    inputs:
      version:
        description: 'Explicit version (e.g., 0.2.0) â€” overrides bump'
        type: string
        default: ''
      bump:
        description: 'Version bump type (patch/minor/major)'
        type: string
        default: 'patch'
      dry_run:
        description: 'Build + test only, skip publish'
        type: boolean
        default: false
      system-deps:
        description: 'apt packages for build/test'
        type: string
        default: ''
      workspace:
        description: 'Workspace mode'
        type: boolean
        default: false
      workspace-crates:
        description: 'Space-separated crate names for workspace version patching'
        type: string
        default: ''
      all-features:
        description: '--all-features for build/test/clippy'
        type: boolean
        default: true
      nextest:
        description: 'Use nextest for release validation'
        type: boolean
        default: true
      cargo-update-flag:
        description: 'Flag for cargo update (-w or -p crate-name)'
        type: string
        default: '-w'
      generate-release-notes:
        description: 'Generate + upload release notes artifact'
        type: boolean
        default: false
      generate-changelog:
        description: 'Update CHANGELOG.md via git-iris'
        type: boolean
        default: false
      cicd-workflow:
        description: 'Downstream workflow to trigger'
        type: string
        default: 'cicd.yml'
      pass-run-id:
        description: 'Pass release_run_id to downstream'
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install system dependencies
        if: inputs.system-deps != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ inputs.system-deps }}

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install nextest
        if: inputs.nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version
        id: version
        run: |
          # Prefer latest git tag, fall back to Cargo.toml
          CURRENT_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1)
          if [ -n "$CURRENT_TAG" ]; then
            current="${CURRENT_TAG#v}"
          else
            current=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)"/\1/')
          fi
          echo "current=$current" >> "$GITHUB_OUTPUT"
          echo "ðŸ“Œ Current version: $current (from tag: ${CURRENT_TAG:-none})"

          if [ -n "${{ inputs.version }}" ]; then
            new="${{ inputs.version }}"
          else
            IFS='.' read -r major minor patch <<< "$current"
            case "${{ inputs.bump }}" in
              major) new="$((major + 1)).0.0" ;;
              minor) new="$major.$((minor + 1)).0" ;;
              patch) new="$major.$minor.$((patch + 1))" ;;
              *) echo "âŒ Invalid bump type: ${{ inputs.bump }}"; exit 1 ;;
            esac
          fi

          # Validate format
          if ! echo "$new" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format: $new (expected: X.Y.Z)"
            exit 1
          fi

          # Check tag doesn't already exist
          if git tag -l "v$new" | grep -q "v$new"; then
            echo "::error::Tag v$new already exists"
            exit 1
          fi

          echo "new=$new" >> "$GITHUB_OUTPUT"
          echo "ðŸ·ï¸ Version: $current â†’ $new"

      - name: Patch Cargo.toml version
        run: |
          sed -i "0,/^version = \".*\"/s//version = \"${{ steps.version.outputs.new }}\"/" Cargo.toml

      - name: Patch workspace crate versions
        if: inputs.workspace-crates != ''
        run: |
          for crate in ${{ inputs.workspace-crates }}; do
            crate_toml="$crate/Cargo.toml"
            if [ -f "$crate_toml" ]; then
              sed -i "0,/^version = \".*\"/s//version = \"${{ steps.version.outputs.new }}\"/" "$crate_toml"
              echo "ðŸ“¦ Patched $crate_toml"
            fi
          done

      - name: Update lockfile
        run: cargo update ${{ inputs.cargo-update-flag }}

      - name: Build
        run: >-
          cargo build
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}

      - name: Run tests (nextest)
        if: inputs.nextest
        run: >-
          cargo nextest run
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}

      - name: Run tests (cargo test)
        if: ${{ !inputs.nextest }}
        run: >-
          cargo test
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}

      - name: Clippy
        run: >-
          cargo clippy
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}
          -- -D warnings

      - name: Commit version bump
        if: ${{ !inputs.dry_run }}
        run: |
          git add Cargo.toml Cargo.lock
          if [ -n "${{ inputs.workspace-crates }}" ]; then
            for crate in ${{ inputs.workspace-crates }}; do
              [ -f "$crate/Cargo.toml" ] && git add "$crate/Cargo.toml"
            done
          fi
          git commit -m "release: v${{ steps.version.outputs.new }}"

      - name: Create and push tag
        if: ${{ !inputs.dry_run }}
        run: |
          git tag -a "v${{ steps.version.outputs.new }}" -m "Release v${{ steps.version.outputs.new }}"
          git push origin HEAD:${{ github.ref_name }}
          git push origin "v${{ steps.version.outputs.new }}"

      - name: Generate release notes
        if: ${{ !inputs.dry_run && inputs.generate-release-notes }}
        uses: hyperb1iss/git-iris@v2
        with:
          provider: anthropic
          model: claude-sonnet-4-5-20250929
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload release notes artifact
        if: ${{ !inputs.dry_run && inputs.generate-release-notes }}
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.md

      - name: Generate changelog
        if: ${{ !inputs.dry_run && inputs.generate-changelog }}
        run: |
          cargo install git-iris || true
          git-iris changelog --provider anthropic --model claude-sonnet-4-5-20250929
          git add CHANGELOG.md
          git commit -m "docs: update changelog for v${{ steps.version.outputs.new }}"
          git push origin HEAD

      - name: Trigger downstream workflow
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          args="--ref v${{ steps.version.outputs.new }}"
          if [ "${{ inputs.pass-run-id }}" = "true" ]; then
            args="$args -f release_run_id=${{ github.run_id }}"
          fi
          gh workflow run "${{ inputs.cicd-workflow }}" $args

      - name: Summary
        run: |
          echo "## Release ${{ inputs.dry_run && '[DRY RUN] ' || '' }}v${{ steps.version.outputs.new }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "Build and tests passed. Run again without dry-run to publish." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Version bumped: ${{ steps.version.outputs.current }} â†’ ${{ steps.version.outputs.new }}" >> "$GITHUB_STEP_SUMMARY"
            echo "Tag pushed: v${{ steps.version.outputs.new }}" >> "$GITHUB_STEP_SUMMARY"
            echo "Downstream workflow triggered: ${{ inputs.cicd-workflow }}" >> "$GITHUB_STEP_SUMMARY"
          fi
