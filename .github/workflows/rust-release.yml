# âœ¨ Rust Release â€” shared-workflows
# Version bump â†’ tag â†’ trigger downstream CI/CD.
# Each consuming repo keeps a thin release.yml with workflow_dispatch inputs
# that calls this shared workflow via workflow_call.

name: Rust Release

on:
  workflow_call:
    inputs:
      version:
        description: "Explicit version (e.g., 0.2.0) â€” overrides bump"
        type: string
        default: ""
      bump:
        description: "Version bump type (patch/minor/major)"
        type: string
        default: "patch"
      dry_run:
        description: "Build + test only, skip publish"
        type: boolean
        default: false
      system-deps:
        description: "apt packages for build/test"
        type: string
        default: ""
      workspace:
        description: "Workspace mode"
        type: boolean
        default: false
      workspace-crates:
        description: "Space-separated crate names for workspace version patching"
        type: string
        default: ""
      all-features:
        description: "--all-features for build/test/clippy"
        type: boolean
        default: true
      nextest:
        description: "Use nextest for release validation"
        type: boolean
        default: true
      cargo-update-flag:
        description: "Flag for cargo update (-w or -p crate-name)"
        type: string
        default: "-w"
      generate-release-notes:
        description: "Generate + upload release notes artifact"
        type: boolean
        default: false
      generate-changelog:
        description: "Update CHANGELOG.md via git-iris"
        type: boolean
        default: false
      cicd-workflow:
        description: "Downstream workflow to trigger"
        type: string
        default: "cicd.yml"
      pass-run-id:
        description: "Pass release_run_id to downstream"
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install system dependencies
        if: inputs.system-deps != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ inputs.system-deps }}

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install nextest
        if: inputs.nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version
        id: version
        run: |
          # Get current version from Cargo.toml
          current=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)"/\1/')
          echo "current=$current" >> "$GITHUB_OUTPUT"

          if [ -n "${{ inputs.version }}" ]; then
            new="${{ inputs.version }}"
          else
            IFS='.' read -r major minor patch <<< "$current"
            case "${{ inputs.bump }}" in
              major) new="$((major + 1)).0.0" ;;
              minor) new="$major.$((minor + 1)).0" ;;
              patch) new="$major.$minor.$((patch + 1))" ;;
            esac
          fi

          echo "new=$new" >> "$GITHUB_OUTPUT"
          echo "ðŸ·ï¸ Version: $current â†’ $new"

      - name: Patch Cargo.toml version
        run: |
          sed -i "0,/^version = \".*\"/s//version = \"${{ steps.version.outputs.new }}\"/" Cargo.toml

      - name: Patch workspace crate versions
        if: inputs.workspace-crates != ''
        run: |
          for crate in ${{ inputs.workspace-crates }}; do
            crate_toml="$crate/Cargo.toml"
            if [ -f "$crate_toml" ]; then
              sed -i "0,/^version = \".*\"/s//version = \"${{ steps.version.outputs.new }}\"/" "$crate_toml"
              echo "ðŸ“¦ Patched $crate_toml"
            fi
          done

      - name: Update lockfile
        run: cargo update ${{ inputs.cargo-update-flag }}

      - name: Build
        run: >-
          cargo build
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}

      - name: Run tests (nextest)
        if: inputs.nextest
        run: >-
          cargo nextest run
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}

      - name: Run tests (cargo test)
        if: ${{ !inputs.nextest }}
        run: >-
          cargo test
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}

      - name: Clippy
        run: >-
          cargo clippy
          --locked
          ${{ inputs.workspace && '--workspace' || '' }}
          ${{ inputs.all-features && '--all-features' || '' }}
          -- -D warnings

      - name: Commit version bump
        if: ${{ !inputs.dry_run }}
        run: |
          git add -A
          git commit -m "chore: bump version to ${{ steps.version.outputs.new }}"

      - name: Create and push tag
        if: ${{ !inputs.dry_run }}
        run: |
          git tag "v${{ steps.version.outputs.new }}"
          git push origin HEAD
          git push origin "v${{ steps.version.outputs.new }}"

      - name: Generate release notes
        if: ${{ !inputs.dry_run && inputs.generate-release-notes }}
        uses: hyperb1iss/git-iris@v2
        with:
          provider: anthropic
          model: claude-sonnet-4-5-20250929
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload release notes artifact
        if: ${{ !inputs.dry_run && inputs.generate-release-notes }}
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.md

      - name: Generate changelog
        if: ${{ !inputs.dry_run && inputs.generate-changelog }}
        run: |
          cargo install git-iris || true
          git-iris changelog --provider anthropic --model claude-sonnet-4-5-20250929
          git add CHANGELOG.md
          git commit -m "docs: update changelog for v${{ steps.version.outputs.new }}"
          git push origin HEAD

      - name: Trigger downstream workflow
        if: ${{ !inputs.dry_run }}
        uses: actions/github-script@v7
        with:
          script: |
            const inputs = { tag: 'v${{ steps.version.outputs.new }}' };
            if (${{ inputs.pass-run-id }}) {
              inputs.release_run_id = '${{ github.run_id }}';
            }
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '${{ inputs.cicd-workflow }}',
              ref: 'v${{ steps.version.outputs.new }}',
              inputs
            });
