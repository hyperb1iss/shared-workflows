# ✨ Docker Publish — shared-workflows
# Build and push Docker images.

name: Docker Publish

on:
  workflow_call:
    inputs:
      image-name:
        description: "Image name (e.g., hyperb1iss/git-iris)"
        type: string
        required: true
      registry:
        description: "docker.io or ghcr.io or both (comma-separated)"
        type: string
        default: "docker.io"
      platforms:
        description: "Docker buildx platforms"
        type: string
        default: "linux/amd64"
      push:
        description: "Actually push (false for test builds)"
        type: boolean
        default: true
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "Dockerfile"
      build-args:
        description: "Docker build arguments"
        type: string
        default: ""

permissions:
  packages: write

concurrency:
  group: docker-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        if: contains(inputs.platforms, ',') || contains(inputs.platforms, 'arm')
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: contains(inputs.registry, 'docker.io')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Login to GitHub Container Registry
        if: contains(inputs.registry, 'ghcr.io')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version tag
        id: meta
        run: |
          version="${GITHUB_REF_NAME#v}"
          echo "version=$version" >> "$GITHUB_OUTPUT"

          # Build tag list based on registries
          tags=""
          IFS=',' read -ra registries <<< "${{ inputs.registry }}"
          for reg in "${registries[@]}"; do
            reg=$(echo "$reg" | xargs)  # trim whitespace
            if [ "$reg" = "docker.io" ]; then
              tags="${tags}${{ inputs.image-name }}:${version},${{ inputs.image-name }}:latest,"
            elif [ "$reg" = "ghcr.io" ]; then
              tags="${tags}ghcr.io/${{ inputs.image-name }}:${version},ghcr.io/${{ inputs.image-name }}:latest,"
            fi
          done
          tags="${tags%,}"  # remove trailing comma
          echo "tags=$tags" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          build-args: ${{ inputs.build-args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
